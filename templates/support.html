{% extends "base.html" %}

{% block title %}Поддержка — FairMarket{% endblock %}

{% block content %}
<section class="support-page">
    <div class="support-layout">
        <div class="support-left">
            <h1 class="support-title">Поддержка ярмарки</h1>
            <p class="support-subtitle">
                Короткий вопрос? Выбери быстрый вариант ответа. Если не нашёл нужное —
                напиши администратору, и мы ответим лично.
            </p>

            <div class="support-faq-block">
                <h2 class="support-block-title">Быстрые ответы</h2>

                <div class="support-faq-buttons">
                    <button class="support-faq-btn" data-faq="site">Проблема с сайтом</button>
                    <button class="support-faq-btn" data-faq="fair">Как работает ярмарка</button>
                    <button class="support-faq-btn" data-faq="login">Не получается войти</button>
                    <button class="support-faq-btn" data-faq="master">Как стать мастером?</button>
                    <button class="support-faq-btn" data-faq="ads">Как публикуются объявления?</button>
                </div>

                <div class="support-answer-box hidden" id="support-answer">
                    <div class="support-answer-title">Ответ</div>
                    <p class="support-answer-text" id="support-answer-text">
                        Выбери вопрос сверху, и здесь появится ответ.
                    </p>
                </div>
            </div>
        </div>

        <div class="support-right">
            <h2 class="support-block-title">Написать администратору</h2>
            <p class="support-right-text">
                Если быстрые ответы не помогли — опиши проблему. Сообщение попадёт в админ-панель,
                где администратор его увидит.
            </p>

            {% if errors %}
            <div class="support-errors">
                {% for e in errors %}
                    • {{ e }}<br>
                {% endfor %}
            </div>
            {% endif %}

            <form method="POST" class="support-form">
                <input type="text"
                       name="subject"
                       class="support-input"
                       id="support-subject"
                       placeholder="Тема обращения">

                <textarea name="text"
                          class="support-textarea"
                          placeholder="Кратко опишите проблему или вопрос"></textarea>

                <button type="submit" class="btn btn-primary support-submit">
                    Отправить администратору
                </button>
            </form>

            <p class="support-note">
                Сообщения сохраняются в разделе <b>«Поддержка»</b> админ-панели как обращения пользователей.
            </p>

            {% if my_messages %}
            <div class="support-history">
                <h3 class="support-history-title">Ваши обращения и ответы</h3>
                <div class="support-history-list">
                    {% for m in my_messages %}
                    <div class="support-history-item">
                        <div class="support-history-header">
                            <span class="support-history-subject">
                                {{ m.subject or "Без темы" }}
                            </span>
                            <span class="support-history-meta">
                                {{ m.created_at.strftime("%d.%m.%Y %H:%M") }}
                                ·
                                {% if m.status == "done" %}
                                    Обработано
                                {% else %}
                                    В обработке
                                {% endif %}
                            </span>
                        </div>
                        <p class="support-history-text">
                            {{ m.text }}
                        </p>

                        {% if m.admin_reply %}
                        <div class="support-history-reply">
                            <div class="support-history-reply-label">
                                Ответ администратора:
                            </div>
                            <p>{{ m.admin_reply }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</section>

<style>
.support-page {
    padding: 40px 0 60px;
}
.support-layout {
    display: grid;
    grid-template-columns: minmax(0, 2fr) minmax(0, 1.8fr);
    gap: 32px;
    align-items: flex-start;
}
@media (max-width: 900px) {
    .support-layout {
        grid-template-columns: 1fr;
    }
}
.support-title {
    font-size: 28px;
    font-weight: 800;
    margin-bottom: 8px;
}
.support-subtitle {
    font-size: 15px;
    color: #555;
    margin-bottom: 20px;
}
.support-block-title {
    font-size: 18px;
    font-weight: 700;
    margin-bottom: 10px;
}
.support-faq-buttons {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 14px;
}
.support-faq-btn {
    border-radius: 999px;
    border: 1px solid #ddd;
    padding: 6px 12px;
    font-size: 13px;
    background: #fff;
    cursor: pointer;
    transition: .2s;
}
.support-faq-btn:hover {
    border-color: #ff4fd8;
    background: #fff7ff;
}
.support-faq-btn.active {
    border-color: #ff4fd8;
    background: #ffe6ff;
}
.support-answer-box {
    background: #fff;
    border-radius: 16px;
    padding: 14px 16px;
    box-shadow: 0 10px 25px rgba(15,23,42,.06);
    font-size: 14px;
}
.support-answer-box.hidden {
    display: none;
}
.support-answer-title {
    font-weight: 600;
    margin-bottom: 4px;
}
.support-right {
    background: #fff;
    border-radius: 20px;
    padding: 20px 20px 18px;
    box-shadow: 0 16px 35px rgba(15,23,42,.07);
}
.support-right-text {
    font-size: 14px;
    color: #555;
    margin-bottom: 12px;
}
.support-input,
.support-textarea {
    width: 100%;
    border-radius: 14px;
    border: 1px solid #ddd;
    padding: 9px 11px;
    font-size: 14px;
    outline: none;
    transition: border-color .2s, box-shadow .2s, background .2s;
    background: rgba(255,255,255,.95);
}
.support-input:focus,
.support-textarea:focus {
    border-color: #ff4fd8;
    box-shadow: 0 0 0 2px rgba(255,79,216,0.16);
    background: #fff;
}
.support-textarea {
    min-height: 110px;
    resize: vertical;
    margin-top: 8px;
}
.support-form {
    display: flex;
    flex-direction: column;
    gap: 8px;
    margin-top: 4px;
}
.support-submit {
    margin-top: 6px;
    align-self: flex-start;
}
.support-note {
    margin-top: 8px;
    font-size: 12px;
    color: #777;
}
.support-errors {
    margin-bottom: 8px;
    font-size: 13px;
    color: #b91c1c;
}

/* История обращений */
.support-history {
    margin-top: 18px;
    border-top: 1px solid #e5e7eb;
    padding-top: 12px;
}
.support-history-title {
    font-size: 15px;
    font-weight: 600;
    margin-bottom: 8px;
}
.support-history-list {
    display: flex;
    flex-direction: column;
    gap: 8px;
}
.support-history-item {
    border-radius: 14px;
    background: #f9fafb;
    padding: 10px 11px;
    font-size: 13px;
}
.support-history-header {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    margin-bottom: 4px;
}
.support-history-subject {
    font-weight: 600;
}
.support-history-meta {
    color: #6b7280;
    font-size: 12px;
}
.support-history-text {
    margin: 2px 0 4px;
}
.support-history-reply {
    margin-top: 4px;
    padding: 6px 8px;
    border-radius: 10px;
    background: #eef2ff;
}
.support-history-reply-label {
    font-weight: 600;
    margin-bottom: 2px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const FAQ_TEXTS = {
        site: "Если страница не открывается или что-то работает странно, попробуйте обновить страницу (Ctrl+F5). Если проблема повторяется — опишите шаги в форме справа и приложите скриншот.",
        fair: "Ярмарка — это набор улиц и павильонов. Мастера размещают объявления в тематических павильонах, пользователи выбирают подходящее объявление и связываются с мастером любым удобным способом, указанным в объявлении.",
        login: "Проверьте логин и пароль. Логин — это ваш никнейм, а не e-mail. Если забыли пароль — напишите администратору через форму, указав ник и e-mail, и мы поможем восстановить доступ.",
        master: "Чтобы стать мастером, выберите роль «мастер» при регистрации или обратитесь к администратору. После этого вы сможете предлагать новые улицы и объявления.",
        ads: "Мастер оставляет заявку на объявление в конкретном павильоне. Администратор проверяет текст и либо публикует объявление, либо отклоняет с комментарием."
    };

    const answerBox   = document.getElementById('support-answer');
    const answerText  = document.getElementById('support-answer-text');
    const subjectInput = document.getElementById('support-subject');

    document.querySelectorAll('.support-faq-btn').forEach(function (btn) {
        btn.addEventListener('click', function () {
            const key = btn.dataset.faq;
            document.querySelectorAll('.support-faq-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');

            if (FAQ_TEXTS[key]) {
                answerText.textContent = FAQ_TEXTS[key];
                answerBox.classList.remove('hidden');
            }

            // подставляем тему в форму обращения
            if (!subjectInput.value) {
                subjectInput.value = btn.textContent.trim();
            }
        });
    });
});
</script>
{% endblock %}
